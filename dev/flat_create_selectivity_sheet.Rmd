---
title: "flat_create_selectivity_sheet.Rmd empty"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r development, include=FALSE}
library(testthat)
```

```{r development-load}
# Load already included functions if relevant
pkgload::load_all()
```

## Sythetic sheet of fishing gear selectivity

<div align="center">**Acronyms**</div>

STD: stands for the standard fishing gear usually used, it is the reference gear 

TEST: stands for the gear modified with a new selective device to be tested

LAN: Fraction of the catch retained by the fisherman (= Landings)

DIS: Part of the catch not retained by the fisherman (= Discards)

FO: Fishing Operation

The sheet is generated in Word format for easy editing. It presents 'relative' selectivity indicators between the TEST gear and the STD gear. They quantify and characterize the improvement or decrease in the selectivity of the TEST gear compared to the STD gear.

<br>

- Gear characteristics: Name, mesh size, selective device

### 1.	Description of the sea trial

&rarr; This section characterizes the conditions associated with the selectivity experiment. It also allows us to verify whether the fishing operations were carried out under similar conditions in the case of a paired protocol.

&rarr;	Number of FOs and trials, dates of trials

-	Boxplot by gear and scatterplot (TEST vs. STD) of fishing duration, fishing speed, depth, time of day, sea state, current speed, current direction, bottom type, catch weight.

### 2.	Catch analysis

#### 2.1.	Discard weight and sorting time

- Boxplots of total discard weights (LAN) and sorting time by FO of both gears (STD and TEST)
- Test to compare the mean or median of catches
- Estimation of the reduction in sorting time

#### 2.2.	Weight per species

- **LAN biomass for a defined list of species**

- Boxplots of LAN weights for both gears (STD and TEST)
- Comparison test of the mean or median of the weights caught over the whole trial by each gear
- Estimation of the variation of the LAN on the cumulated weights caught and intra pairs

- **DIS biomass for a defined list of discarded species**

- Distribution of DIS weights of both gears
- Comparison test of the mean or median of the weights caught at the scale of the FO 
- Estimation of cumulative and intra-pair variation in DIS


### 3.	Size selectivity for a defined list of species

- Histograms of length distribution of the catches of the two gears (from the total catch and by fraction)
- Relative selectivity by size class (TEST/(TEST+STD))
- Estimate of the escapement rate of individuals below commercial size (1-TEST/STD)


# `create_selectivity_sheet()`

```{r function-create_selectivity_sheet}
#' create_selectivity_sheet
#'
#' @description Generate a selectivity sheet describing data and gathering a set of selectivity indicators.
#' 
#' @param data data.frame A data.frame as generated by prep_sel_data() 
#' @param protocol character Type of protocol. "twin" for experiment where both fishing gear are deployed in the same fishing operation (e.g. using twin trawls) ; "paired" for experiment where the two fishing gear are deployed in a set of 'pairs' : two different fishing operations, but in very similar conditions; "unpaired" for experiment where the gear are tested independently in two different samples of fishing operations.
#' @param output_dir character Directory name where the sheet should be written
#' @param output_file character Name of the file for the sheet
#' @param min_length numeric Optional. For species analyzed in length, the minimum targeted length for selectivity (e.g., MCRS) for graphics and statistics. A data.frame with a column 'species' and a column 'min_length' for the corresponding minimum length.
#' @param language character English by default ("EN"). Can be passed in French ("FR").
#' @param zones character The vector of zones used in the report.
#'
#' @importFrom rmarkdown render
#  imports within Rmd templates
#' @importFrom dplyr group_by summarise summarize select filter bind_rows
#' @importFrom knitr kable
#' @importFrom ggplot2 ggplot aes geom_boxplot geom_point theme xlab element_text element_blank labs stat_summary position_dodge theme_light scale_x_discrete xlim ylim  geom_bar geom_vline geom_hline guides ggtitle guide_legend
#' @importFrom ggpubr ggarrange
#' @importFrom stats shapiro.test t.test wilcox.test
#' @importFrom tidyr complete nesting
#' 
#' @return None A Word document is generated in the output_dir as well as all the figures in png.
#' For more details on the selectivity sheet format, see the related vignette :
#' \code{vignette("create-selectivity-sheet", package = "inser")}
#' @export
#'
#' @examples
create_selectivity_sheet <- function(
    data,
    protocol,
    output_dir = NULL,
    output_file = NULL,
    min_length = NULL,
    language = "EN",
    zones
) {
  
  # Check arguments protocol and language were provided with legible values
  protocol <- match.arg(
    arg = protocol, 
    choices = c("twin", "paired", "unpaired")
  )
  language <- match.arg(
    arg = language, 
    choices = c("FR", "EN")
  )
  
  #How to make by default the same parameters as in the render() function?
  
  ##Control function parameters?

  Maps <- create_maps(
    data = data, 
    zones = zones,
    protocol = protocol
  )
  
  # Setup template report path
  path_templates <- system.file("template", package = "inser")
  
  # Setup language translation object
  lg <- create_translate_dict(
    path = system.file("template", "translation_2_utf8.csv", package = "inser"),
    language = language
  )
  
  path_template_rmd <- file.path(
    path_templates,
    sprintf(
      "selectivity_sheet_%s.Rmd",
      protocol
    )
  )
  
  render(
    input = path_template_rmd,
    output_dir = output_dir,
    output_file = output_file,
    params = list(lg = lg)
  )
  
}
```

```{r examples-create_selectivity_sheet}
# Create tmp folder
output_dir <- tempfile(pattern = "inser")
dir.create(output_dir)

# Setup input OTT data
OTT_data_folder <- system.file("script_origin","Data","Example_OTT", package = "inser")

TR <- readr::read_delim(
  file = file.path(OTT_data_folder, "TR.csv"),
  delim = ";",
  escape_double = FALSE,
  locale = readr::locale(encoding = "WINDOWS-1252"),
  trim_ws = TRUE
)

HH<-read.table(
  file.path(OTT_data_folder, "HH.csv"),
  sep=";",
  header=TRUE,
  encoding = "WINDOWS-1252")#,colClasses = colClasses)

SL<-read.table(
  file.path(OTT_data_folder, "SL.csv"),
  sep=";",
  header=TRUE,
  encoding = "WINDOWS-1252")

HL<-read.table(
  file.path(OTT_data_folder, "HL.csv"),
  sep=";",
  header=TRUE,
  encoding = "WINDOWS-1252")

colClasses<-rep(NA,ncol(HH))
colClasses[which(names(HH)=="statistical_rectangle")]<-"character"

HH<-read.table(
  file.path(OTT_data_folder, "HH.csv"),
  sep=";",
  header=TRUE,
  colClasses = colClasses,
  encoding = "WINDOWS-1252")

# create TAB output
TAB <- prep_sel_data(data=list(TR,HH,SL,HL))

# Setup zone and min_length params
min_length <- data.frame(species=unique(TAB$species),min_length=c(27,24,20,NA,27,NA))
zones <- c("8.a","8.b","7.d","7.e","7.h")

# run function
create_selectivity_sheet(data = TAB,
                         output_dir = output_dir,
                         output_file = "fiche_InseR_twin",
                         protocol = "twin",
                         language = "FR",
                         zones=zones,
                         min_length=min_length)

# rstudioapi::filesPaneNavigate(output_dir)

# Clear tmp folder
unlink(output_dir, recursive = TRUE)
```

```{r tests-create_selectivity_sheet}
test_that("create_selectivity_sheet works in French", {
  # Create tmp folder
  output_dir <- tempfile(pattern = "inser")
  dir.create(output_dir)
  
  # Setup input OTT data
  OTT_data_folder <- system.file("script_origin","Data","Example_OTT", package = "inser")
  
  TR <- readr::read_delim(
    file = file.path(OTT_data_folder, "TR.csv"),
    delim = ";",
    escape_double = FALSE,
    locale = readr::locale(encoding = "WINDOWS-1252"),
    trim_ws = TRUE
  )
  
  HH<-read.table(
    file.path(OTT_data_folder, "HH.csv"),
    sep=";",
    header=TRUE,
    encoding = "WINDOWS-1252")#,colClasses = colClasses)
  
  SL<-read.table(
    file.path(OTT_data_folder, "SL.csv"),
    sep=";",
    header=TRUE,
    encoding = "WINDOWS-1252")
  
  HL<-read.table(
    file.path(OTT_data_folder, "HL.csv"),
    sep=";",
    header=TRUE,
    encoding = "WINDOWS-1252")
  
  colClasses<-rep(NA,ncol(HH))
  colClasses[which(names(HH)=="statistical_rectangle")]<-"character"
  
  HH<-read.table(
    file.path(OTT_data_folder, "HH.csv"),
    sep=";",
    header=TRUE,
    colClasses = colClasses,
    encoding = "WINDOWS-1252")
  
  # create TAB output
  TAB <- prep_sel_data(data=list(TR,HH,SL,HL))
  
  # Setup zone and min_length params
  min_length <- data.frame(species=unique(TAB$species),min_length=c(27,24,20,NA,27,NA))
  zones <- c("8.a","8.b","7.d","7.e","7.h")
  
  # run function for "twin" report
  #' @description Testing no error occur during the generation of the "twin" report
  expect_error(
    create_selectivity_sheet(
      data = TAB,
      output_dir = output_dir,
      output_file = "fiche_InseR_twin",
      protocol = "twin",
      language = "FR",
      zones = zones,
      min_length = min_length
    ), 
    NA
  )
  
  #' @description Testing the "twin" report from `create_selectivity_sheet()` is created
  expect_true(file.exists(file.path(output_dir, "fiche_InseR_twin.docx")))
  
  # unzip doc to access figures and tables
  unzip(
    zipfile = file.path(output_dir, "fiche_InseR_twin.docx"),
    exdir = file.path(output_dir, "unzip_twin")
  )
  
  #' @description Testing all figures are present in the "twin" report
  expect_length(
    list.files(
      file.path(output_dir, "unzip_twin", "word", "media")
    ),
    28
  )
  
  
  # Setup OTB input data
  OTB_data_folder <- system.file("script_origin","Data","Example_OTB_alternate", package = "inser")
  
  TR <- readr::read_delim(
    file = file.path(OTB_data_folder, "TR.csv"),
    delim = ";",
    escape_double = FALSE,
    locale = readr::locale(encoding = "WINDOWS-1252"),
    trim_ws = TRUE
  )
  HH<-read.table(file.path(OTB_data_folder, "HH.csv"),sep=";",header=TRUE, encoding = "WINDOWS-1252")#,colClasses = colClasses)
  SL<-read.table(file.path(OTB_data_folder, "SL.csv"),sep=";",header=TRUE, encoding = "WINDOWS-1252")
  HL<-read.table(file.path(OTB_data_folder, "HL.csv"),sep=";",header=TRUE, encoding = "WINDOWS-1252")
  
  colClasses<-rep(NA,ncol(HH))
  colClasses[which(names(HH)=="statistical_rectangle")]<-"character"
  
  HH<-read.table(file.path(OTB_data_folder, "HH.csv"),sep=";",header=TRUE,colClasses = colClasses, encoding = "WINDOWS-1252")
  
  # create TAB output
  TAB<-prep_sel_data(data=list(TR,HH,SL,HL))
  
  # run function for "paired" report
  #' @description Testing no error occur during the generation of the "paired" report
  expect_error(
    create_selectivity_sheet(
      data = TAB,
      output_dir = output_dir,
      output_file = "fiche_InseR_paired",
      protocol = "paired",
      language = "FR",
      zones = zones,
      min_length = min_length
    ), 
    NA
  )
  
  #' @description Testing the "paired" report from `create_selectivity_sheet()` is created
  expect_true(file.exists(file.path(output_dir, "fiche_InseR_paired.docx")))
  
  # unzip doc to access figures and tables
  unzip(
    zipfile = file.path(output_dir, "fiche_InseR_paired.docx"),
    exdir = file.path(output_dir, "unzip_paired")
  )
  
  #' @description Testing all figures are present in the "paired" report
  expect_length(
    list.files(
      file.path(output_dir, "unzip_paired", "word", "media")
    ),
    28
  )
  
  # run function for "unpaired" report
  #' @description Testing no error occur during the generation of the "unpaired" report
  expect_error(
    create_selectivity_sheet(
      data = TAB,
      output_dir = output_dir,
      output_file = "fiche_InseR_unpaired",
      protocol = "unpaired",
      language = "FR",
      zones = zones,
      min_length = min_length
    ), 
    NA
  )
  
  #' @description Testing the "unpaired" report from `create_selectivity_sheet()` is created
  expect_true(file.exists(file.path(output_dir, "fiche_InseR_unpaired.docx")))
  
  # unzip doc to access figures and tables
  unzip(
    zipfile = file.path(output_dir, "fiche_InseR_unpaired.docx"),
    exdir = file.path(output_dir, "unzip_unpaired")
  )
  
  #' @description Testing all figures are present in the "unpaired" report
  expect_length(
    list.files(
      file.path(output_dir, "unzip_unpaired", "word", "media")
    ),
    28
  )
  
  # Clear tmp folder
  unlink(output_dir, recursive = TRUE)
})

test_that("create_selectivity_sheet works in English", {
  # Create tmp folder
  output_dir <- tempfile(pattern = "inser")
  dir.create(output_dir)
  
  # Setup input OTT data
  OTT_data_folder <- system.file("script_origin","Data","Example_OTT", package = "inser")
  
  TR <- readr::read_delim(
    file = file.path(OTT_data_folder, "TR.csv"),
    delim = ";",
    escape_double = FALSE,
    locale = readr::locale(encoding = "WINDOWS-1252"),
    trim_ws = TRUE
  )
  
  HH<-read.table(
    file.path(OTT_data_folder, "HH.csv"),
    sep=";",
    header=TRUE,
    encoding = "WINDOWS-1252")#,colClasses = colClasses)
  
  SL<-read.table(
    file.path(OTT_data_folder, "SL.csv"),
    sep=";",
    header=TRUE,
    encoding = "WINDOWS-1252")
  
  HL<-read.table(
    file.path(OTT_data_folder, "HL.csv"),
    sep=";",
    header=TRUE,
    encoding = "WINDOWS-1252")
  
  colClasses<-rep(NA,ncol(HH))
  colClasses[which(names(HH)=="statistical_rectangle")]<-"character"
  
  HH<-read.table(
    file.path(OTT_data_folder, "HH.csv"),
    sep=";",
    header=TRUE,
    colClasses = colClasses,
    encoding = "WINDOWS-1252")
  
  # create TAB output
  TAB <- prep_sel_data(data=list(TR,HH,SL,HL))
  
  # Setup zone and min_length params
  min_length <- data.frame(species=unique(TAB$species),min_length=c(27,24,20,NA,27,NA))
  zones <- c("8.a","8.b","7.d","7.e","7.h")
  
  # run function for "twin" report
  #' @description Testing no error occur during the generation of the "twin" report
  expect_error(
    create_selectivity_sheet(
      data = TAB,
      output_dir = output_dir,
      output_file = "fiche_InseR_twin",
      protocol = "twin",
      language = "EN",
      zones = zones,
      min_length = min_length
    ), 
    NA
  )
  
  #' @description Testing the "twin" report from `create_selectivity_sheet()` is created
  expect_true(file.exists(file.path(output_dir, "fiche_InseR_twin.docx")))
  
  # unzip doc to access figures and tables
  unzip(
    zipfile = file.path(output_dir, "fiche_InseR_twin.docx"),
    exdir = file.path(output_dir, "unzip_twin")
  )
  
  #' @description Testing all figures are present in the "twin" report
  expect_length(
    list.files(
      file.path(output_dir, "unzip_twin", "word", "media")
    ),
    28
  )
  
  
  # Setup OTB input data
  OTB_data_folder <- system.file("script_origin","Data","Example_OTB_alternate", package = "inser")
  
  TR <- readr::read_delim(
    file = file.path(OTB_data_folder, "TR.csv"),
    delim = ";",
    escape_double = FALSE,
    locale = readr::locale(encoding = "WINDOWS-1252"),
    trim_ws = TRUE
  )
  HH<-read.table(file.path(OTB_data_folder, "HH.csv"),sep=";",header=TRUE, encoding = "WINDOWS-1252")#,colClasses = colClasses)
  SL<-read.table(file.path(OTB_data_folder, "SL.csv"),sep=";",header=TRUE, encoding = "WINDOWS-1252")
  HL<-read.table(file.path(OTB_data_folder, "HL.csv"),sep=";",header=TRUE, encoding = "WINDOWS-1252")
  
  colClasses<-rep(NA,ncol(HH))
  colClasses[which(names(HH)=="statistical_rectangle")]<-"character"
  
  HH<-read.table(file.path(OTB_data_folder, "HH.csv"),sep=";",header=TRUE,colClasses = colClasses, encoding = "WINDOWS-1252")
  
  # create TAB output
  TAB<-prep_sel_data(data=list(TR,HH,SL,HL))
  
  # run function for "paired" report
  #' @description Testing no error occur during the generation of the "paired" report
  expect_error(
    create_selectivity_sheet(
      data = TAB,
      output_dir = output_dir,
      output_file = "fiche_InseR_paired",
      protocol = "paired",
      language = "EN",
      zones = zones,
      min_length = min_length
    ), 
    NA
  )
  
  #' @description Testing the "paired" report from `create_selectivity_sheet()` is created
  expect_true(file.exists(file.path(output_dir, "fiche_InseR_paired.docx")))
  
  # unzip doc to access figures and tables
  unzip(
    zipfile = file.path(output_dir, "fiche_InseR_paired.docx"),
    exdir = file.path(output_dir, "unzip_paired")
  )
  
  #' @description Testing all figures are present in the "paired" report
  expect_length(
    list.files(
      file.path(output_dir, "unzip_paired", "word", "media")
    ),
    28
  )
  
  # run function for "unpaired" report
  #' @description Testing no error occur during the generation of the "unpaired" report
  expect_error(
    create_selectivity_sheet(
      data = TAB,
      output_dir = output_dir,
      output_file = "fiche_InseR_unpaired",
      protocol = "unpaired",
      language = "EN",
      zones = zones,
      min_length = min_length
    ), 
    NA
  )
  
  #' @description Testing the "unpaired" report from `create_selectivity_sheet()` is created
  expect_true(file.exists(file.path(output_dir, "fiche_InseR_unpaired.docx")))
  
  # unzip doc to access figures and tables
  unzip(
    zipfile = file.path(output_dir, "fiche_InseR_unpaired.docx"),
    exdir = file.path(output_dir, "unzip_unpaired")
  )
  
  #' @description Testing all figures are present in the "unpaired" report
  expect_length(
    list.files(
      file.path(output_dir, "unzip_unpaired", "word", "media")
    ),
    28
  )
  
  # Clear tmp folder
  unlink(output_dir, recursive = TRUE)
})
```


```{r development-inflate, eval=FALSE}
# Run but keep eval=FALSE to avoid infinite loop
# Execute in the console directly
fusen::inflate(flat_file = "dev/flat_create_selectivity_sheet.Rmd",
               vignette_name = "Create selectivity sheet",
               overwrite = TRUE,
               check = FALSE)
```

